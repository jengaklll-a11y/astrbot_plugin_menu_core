<!DOCTYPE html>
<html lang="zh-CN" data-theme="dark"> <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AstrBot Menu Studio</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <style>
        /* === ÂèòÈáèÂÆö‰πâ === */
        :root { 
            --bg-body: #000000; --bg-sidebar: #1c1c1e; --text-main: #ffffff; --text-sub: #8e8e93; --border: #38383a;
            --glass-bg: rgba(255, 255, 255, 0.08); --glass-border: rgba(255, 255, 255, 0.12);
            --preview-bg: #000000; --preview-group: #1c1c1e; --group-border: #38383a;
            --accent: #0a84ff; --success: #30d158; --danger: #ff453a; --radius-m: 12px;
        }
        [data-theme="light"] {
            --bg-body: #ffffff; --bg-sidebar: #ffffff; --text-main: #000000; --text-sub: #6c6c70; --border: #e5e5ea;
            --glass-bg: rgba(0, 0, 0, 0.04); --glass-border: rgba(0, 0, 0, 0.05);
            --preview-bg: #ffffff; --preview-group: #f2f2f7; --group-border: #e5e5ea;
        }
        
        * { box-sizing: border-box; outline: none; }
        ::-webkit-scrollbar { display: none; }
        body { margin: 0; padding: 0; font-family: -apple-system, "Microsoft YaHei", sans-serif; background: var(--bg-body); color: var(--text-main); height: 100vh; overflow: hidden; transition: background 0.3s, color 0.3s; }
        .app { display: flex; height: 100vh; width: 100vw; }
        
        .sidebar { width: 420px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; z-index: 20; transition: background 0.3s, border 0.3s; }
        .sidebar-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 15px; flex-shrink: 0; }
        .header-top { display: flex; justify-content: space-between; align-items: center; }
        .header-title { font-weight: 800; font-size: 1.2rem; color: var(--text-main); }
        .theme-toggle { cursor: pointer; padding: 6px 12px; background: var(--glass-bg); border-radius: 20px; font-size: 1rem; border: 1px solid var(--border); color: var(--text-main); transition: 0.2s; }
        .theme-toggle:hover { background: rgba(128,128,128,0.1); }
        .action-row { display: flex; gap: 10px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 20px; }
        
        .control-group { background: transparent; border: none; padding: 0; margin-bottom: 25px; display: flex; flex-direction: column; gap: 12px; }
        .form-row { margin-bottom: 0; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); background: var(--glass-bg); border: 1px solid var(--border); border-radius: var(--radius-m); padding: 0 16px; height: 54px; transition: 0.2s; }
        .form-row:hover { border-color: var(--accent); background: rgba(128,128,128,0.1); }
        label { color: var(--text-main); font-size: 0.95rem; font-weight: 600; white-space: nowrap; margin-right: 10px;}
        input[type="range"] { flex: 1; accent-color: var(--accent); cursor: pointer;}
        
        .align-group { display: flex; background: rgba(0,0,0,0.2); border-radius: 8px; padding: 2px; gap: 2px; height: 32px; width: 140px;}
        .align-btn { flex: 1; border: none; background: transparent; color: var(--text-sub); border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600; transition: 0.2s; }
        .align-btn.active { background: var(--accent); color: white; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        
        .outline-group { background: var(--glass-bg); border-radius: var(--radius-m); overflow: hidden; border: 1px solid var(--border); margin-bottom: 10px; }
        .outline-header { height: 54px; padding: 0 10px; display: flex; align-items: center; gap: 10px; border-bottom: 1px solid var(--border); cursor: grab; }
        .outline-header .deco-bar { width: 4px; height: 16px; border-radius: 2px; margin: 0 8px; flex-shrink: 0; }
        
        .delete-wrapper { height: 32px; display: flex; align-items: center; margin-left: auto; }
        .confirm-actions { height: 32px; display: flex; align-items: center; gap: 2px; background: var(--glass-bg); border-radius: 8px; padding: 0 4px 0 12px; border: 1px solid var(--border); animation: slideLeft 0.2s cubic-bezier(0.2, 0, 0, 1); box-sizing: border-box; overflow: hidden; }
        @keyframes slideLeft { from { opacity: 0; width: 32px; } to { opacity: 1; width: 110px; } }
        .btn-icon { width: 28px; height: 28px; border-radius: 8px; background: transparent; border: none; color: var(--text-sub); cursor: pointer; display: flex; align-items: center; justify-content: center; flex-shrink: 0; transition: 0.2s; }
        .btn-icon:hover { background: rgba(128,128,128,0.1); color: var(--text-main); transform: scale(1.1); }
        .btn-yes { color: var(--success) !important; }
        .btn-yes:hover { background: rgba(48, 209, 88, 0.2) !important; }
        .btn-no { color: var(--danger) !important; }
        .btn-no:hover { background: rgba(255, 69, 58, 0.2) !important; }

        .outline-item { padding: 8px 10px 8px 30px; display: flex; align-items: center; justify-content: space-between; font-size: 0.9rem; color: var(--text-main); border-top: 1px solid transparent; }
        
        .main-area { flex: 1; background: var(--bg-body); display: flex; justify-content: center; position: relative; transition: background 0.3s; }
        .viewport { flex: 1; overflow: auto; padding: 60px; display: flex; justify-content: center; align-items: flex-start; background-color: var(--preview-bg); background-image: radial-gradient(var(--border) 1px, transparent 1px); background-size: 20px 20px; transition: background-color 0.3s; }
        
        /* === ÁîªÂ∏ÉÂü∫Á°ÄÊ†∑Âºè === */
        .canvas-list { 
            width: 800px; min-height: 800px; 
            background: var(--preview-bg); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.1); 
            transform-origin: top center; 
            transition: transform 0.2s; 
            margin-bottom: 100px;
            box-sizing: border-box;
            padding: 50px 0;
        }

        .canvas-grid { 
            width: 800px; min-height: 800px; 
            background: var(--preview-bg); 
            border: 1px solid var(--border); 
            border-radius: 20px; 
            box-shadow: 0 0 100px rgba(0,0,0,0.1); 
            transform-origin: top center; 
            transition: transform 0.2s; 
            margin-bottom: 100px;
            box-sizing: border-box;
            padding: 50px 30px; /* Ëá™Áî±ÁΩëÊ†ºÂÜÖËæπË∑ù */
        }
        
        .header-area { padding: 0 30px; margin-bottom: 20px; width: 100%; box-sizing: border-box; }
        .divider { height: 1px; background: var(--border); margin: 0 30px 40px 30px; }
        .group-container { margin: 0 30px 30px 30px; padding: 25px; background: var(--preview-group); border-radius: 18px; border: 1px solid var(--group-border); }
        .group-header { display: flex; align-items: center; margin-bottom: 20px; }
        .group-deco { width: 6px; height: 30px; margin-right: 15px; border-radius: 3px; }
        
        input.editable { background: transparent; border: 1px solid transparent; width: 100%; padding: 0 !important; margin: 0 !important; transition: 0.2s; border-radius: 4px; font-family: inherit; line-height: 1.4; }
        input.editable:hover { border: 1px dashed var(--border); }
        .text-main { font-size: 48px; font-weight: 800; color: var(--text-main) !important; margin-bottom: 10px; display: block; }
        .text-sub { font-size: 24px; color: var(--text-sub) !important; margin-bottom: 30px; display: block; }
        .text-group { font-size: 28px; color: var(--text-main) !important; font-weight: 600; flex: 1; padding: 0 !important;}
        
        .menu-grid { display: grid; gap: 15px; }
        .menu-card { height: 80px; position: relative; cursor: move; border-radius: 12px; background: var(--glass-bg); border: 1px solid var(--glass-border); display: flex; overflow: hidden; transition: 0.2s; }
        .menu-card:hover { transform: scale(1.02); border-color: var(--accent); z-index: 10; }
        .card-content { flex: 1; padding: 0 20px; display: flex; flex-direction: column; justify-content: center; }
        .text-item-title { font-size: 18px; color: var(--text-main) !important; margin-bottom: 4px; font-weight: 600; }
        .text-item-desc { font-size: 14px; color: var(--text-sub) !important; }

        .btn { padding: 10px 20px; border-radius: 99px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 6px; transition: 0.2s; box-shadow: 0 2px 5px rgba(0,0,0,0.1); justify-content: center;}
        .btn-primary { background: var(--accent); color: white; width: 100%; }
        .btn-success { background: var(--success); color: white; width: 100%; }
        .btn-ghost { background: transparent; color: var(--text-sub); }
        
        .modal-mask { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); z-index: 2000; display: flex; justify-content: center; align-items: center; }
        .preview-image { max-width: 90%; max-height: 90vh; border-radius: 12px; box-shadow: 0 20px 80px rgba(0,0,0,0.5); }
        
        .toast { position: absolute; top: 20px; left: 50%; transform: translateX(-50%) translateY(-20px); background: #333; color: white; padding: 8px 24px; border-radius: 30px; opacity: 0; transition: 0.3s cubic-bezier(0.18, 0.89, 0.32, 1.28); pointer-events: none; z-index: 3000; font-size: 1rem; font-weight: bold; box-shadow: 0 8px 20px rgba(0,0,0,0.3); }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }

        .mode-switcher { display: flex; background: var(--glass-bg); padding: 4px; border-radius: 10px; border: 1px solid var(--border); margin-top: 15px; } 
        .mode-btn { flex: 1; background: transparent; border: none; padding: 8px; color: var(--text-sub); border-radius: 8px; cursor: pointer; transition: 0.2s; font-weight: 600; }
        .mode-btn.active-list { background: var(--accent); color: white; box-shadow: 0 2px 8px rgba(10, 132, 255, 0.3); }
        .mode-btn.active-grid { background: var(--success); color: white; box-shadow: 0 2px 8px rgba(48, 209, 88, 0.3); }

        .widget-grid { display: grid; grid-template-columns: repeat(var(--grid-cols, 4), 1fr); gap: 20px; grid-auto-flow: dense; margin-top: 30px; }
        .group-widget { background: var(--preview-group); border: 1px solid var(--group-border); border-radius: 16px; padding: 20px; display: flex; flex-direction: column; position: relative; transition: all 0.2s; }
        .group-widget:hover { transform: translateY(-2px); border-color: var(--accent); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        
        .resize-controls { position: absolute; top: 12px; right: 12px; display: flex; gap: 4px; opacity: 0; transition: 0.2s; background: var(--bg-body); padding: 4px; border-radius: 6px; border: 1px solid var(--border); }
        .group-widget:hover .resize-controls { opacity: 1; }
        .btn-mini { padding: 4px 8px; font-size: 12px; background: rgba(128,128,128,0.2); color: var(--text-main); border-radius: 4px; border:none; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-mini:hover { background: var(--accent); color: white; }

        /* ÊãñÊãΩÊâãÊüÑ */
        .resize-handle-drag { position: absolute; bottom: 0; right: 0; width: 30px; height: 30px; cursor: nwse-resize; z-index: 100; opacity: 0.3; transition: 0.2s; display: flex; align-items: flex-end; justify-content: flex-end; padding: 5px; }
        .group-widget:hover .resize-handle-drag { opacity: 1; }
        .resize-icon { width: 12px; height: 12px; border-right: 3px solid var(--text-sub); border-bottom: 3px solid var(--text-sub); border-bottom-right-radius: 4px; pointer-events: none; }
        .group-widget.resizing { border-color: var(--success); box-shadow: 0 0 0 2px rgba(48, 209, 88, 0.2); z-index: 100; }

        .gw-header { display: flex; align-items: center; margin-bottom: 15px; gap: 10px; }
        .gw-deco { width: 4px; height: 20px; border-radius: 2px; flex-shrink: 0;}
        .menu-pill { background: var(--glass-bg); padding: 8px 12px; border-radius: 8px; display: flex; align-items: center; gap: 5px; border: 1px solid transparent; }
        .menu-pill:hover { border-color: var(--border); }
        .menu-pill input { font-size: 14px; }
    </style>
</head>
<body>
    <div id="app" class="app" @mouseup="handleResizeUp" @mousemove="handleResizeMove">
        <div class="sidebar">
            <div class="sidebar-header">
                <div class="header-top">
                    <span class="header-title">ËèúÂçïÈÖçÁΩÆ</span>
                    <div class="theme-toggle" @click="toggleTheme">{{ config.design.theme === 'light' ? 'üåû ÊµÖËâ≤' : 'üåô Ê∑±Ëâ≤' }}</div>
                </div>
                
                <div class="action-row">
                    <button class="btn btn-success" @click="fetchBackendPreview">üîç È¢ÑËßà</button>
                    <button class="btn btn-primary" @click="saveConfig" :disabled="saving">{{ saving ? '...' : 'üíæ ‰øùÂ≠ò' }}</button>
                </div>

                <div class="mode-switcher">
                    <button :class="['mode-btn', config.design.layout_mode === 'list' ? 'active-list' : '']" @click="switchMode('list')">ÁªèÂÖ∏ÂàóË°®</button>
                    <button :class="['mode-btn', config.design.layout_mode === 'grid' ? 'active-grid' : '']" @click="switchMode('grid')">Ëá™Áî±ÁΩëÊ†º</button>
                </div>
            </div>
            
            <div class="sidebar-content">
                <div class="control-group">
                    <div class="form-row">
                        <label>ÁîªÂ∏ÉÁº©Êîæ</label>
                        <input type="range" v-model.number="zoom" min="0.5" max="1.5" step="0.1">
                        <span style="width:30px; text-align:right">{{ Math.round(zoom*100) }}%</span>
                    </div>
                    
                    <div class="form-row" v-if="config.design.layout_mode === 'list'">
                        <label>Âç°ÁâáÂàóÊï∞</label>
                        <input type="range" v-model.number="getDesign().layout_columns" min="1" max="3" step="1">
                    </div>

                    <div class="form-row" v-if="config.design.layout_mode === 'grid'">
                        <label>Âç°ÁâáÂàóÊï∞</label>
                        <input type="range" v-model.number="getDesign().grid_columns" min="1" max="3" step="1">
                    </div>

                    <div class="form-row">
                        <label>Ê†áÈ¢òÂØπÈΩê</label>
                        <div class="align-group">
                            <button class="align-btn" :class="{active: getDesign().title_align === 'left'}" @click="getDesign().title_align = 'left'">Â∑¶</button>
                            <button class="align-btn" :class="{active: getDesign().title_align === 'center'}" @click="getDesign().title_align = 'center'">‰∏≠</button>
                            <button class="align-btn" :class="{active: getDesign().title_align === 'right'}" @click="getDesign().title_align = 'right'">Âè≥</button>
                        </div>
                    </div>
                </div>

                <div v-for="(group, gIdx) in config.groups" :key="gIdx" class="outline-group"
                     draggable="true" @dragstart="dragStartGroup(gIdx, $event)" @dragover.prevent @drop="dropOnGroupList(gIdx)">
                    
                    <div class="outline-header">
                        <span style="cursor:grab; color:var(--text-sub)">‚ò∞</span>
                        <div class="deco-bar" :style="{background: getGroupColor(gIdx)}"></div>
                        <input type="text" v-model="group.title" style="flex:1; background:transparent; border:none; font-weight:600; color:var(--text-main)" placeholder="ÂàÜÁªÑÂêç">
                        
                        <div class="delete-wrapper">
                            <button v-if="deleteTargetIdx !== gIdx" class="btn-icon" @click="askDelete(gIdx)" title="Âà†Èô§ÂàÜÁªÑ">üóëÔ∏è</button>
                            <div v-else class="confirm-actions">
                                <span style="font-size:12px; color:var(--text-sub); margin-right:2px; white-space:nowrap; line-height: 1;">Á°ÆËÆ§?</span>
                                <button class="btn-icon btn-yes" @click="removeGroup(gIdx)">‚úÖ</button>
                                <button class="btn-icon btn-no" @click="cancelDelete()">‚ùå</button>
                            </div>
                        </div>
                    </div>
                    
                    <div v-if="group.enabled !== false" style="padding:10px;">
                        <div v-for="(item, iIdx) in group.menus" :key="iIdx" style="display:flex; align-items:center; margin-bottom:5px; font-size:13px; color:var(--text-sub);">
                            <span style="flex:1; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">- {{ item.name || 'Êú™ÂëΩÂêç' }}</span>
                            <span class="btn-icon" style="width:20px; height:20px;" @click="removeItem(gIdx, iIdx)">√ó</span>
                        </div>
                        <button class="btn" style="font-size:0.8rem; width:100%; background: rgba(0,0,0,0.1); border: 1px dashed var(--border); color: var(--text-sub); height:30px; min-height:0; padding:0;" @click="addItem(gIdx)">+ Ê∑ªÂä†ÂäüËÉΩ</button>
                    </div>
                </div>
                <button class="btn btn-ghost" style="width:100%; border:1px dashed var(--border); margin-top:10px;" @click="addGroup">+ Êñ∞Âª∫ÂàÜÁªÑ</button>
            </div>
        </div>

        <div class="main-area">
            <div :class="['toast', toastClass]">{{ toastMsg }}</div>

            <div class="viewport">
                <template v-if="config.design.layout_mode === 'list'">
                    <div class="canvas-list" :style="{ transform: `scale(${zoom})`, transformOrigin: 'top center' }">
                        <div class="header-area">
                            <input class="editable text-main" v-model="config.title" placeholder="ËøôÈáåËÆæÁΩÆ‰∏ªÊ†áÈ¢ò..." :style="{ textAlign: getDesign().title_align }">
                            <input class="editable text-sub" v-model="config.subtitle" placeholder="ÁÇπÂáªËÆæÁΩÆÂâØÊ†áÈ¢ò..." :style="{ textAlign: getDesign().title_align }">
                        </div>
                        <div class="divider"></div>

                        <template v-for="(group, gIdx) in config.groups" :key="gIdx">
                            <div v-if="group.enabled !== false" class="group-container" @dragover.prevent @drop="dropOnGroupCanvas(gIdx)">
                                <div class="group-header" :style="{ justifyContent: group.align === 'center' ? 'center' : 'flex-start' }">
                                    <div v-if="group.align === 'left'" class="group-deco" :style="{ background: getGroupColor(gIdx) }"></div>
                                    <input class="editable text-group" v-model="group.title" :style="{ textAlign: group.align }">
                                </div>
                                <div class="menu-grid" :style="{ gridTemplateColumns: `repeat(${getDesign().layout_columns}, 1fr)` }">
                                    <template v-for="(item, iIdx) in group.menus" :key="iIdx">
                                        <div class="menu-card" draggable="true" @dragstart="dragStartItem(gIdx, iIdx, $event)" @dragover.prevent @drop.stop="dropOnItem(gIdx, iIdx)">
                                            <div class="card-content">
                                                <input class="editable text-item-title" v-model="item.name" placeholder="ÂäüËÉΩÂêç">
                                                <input class="editable text-item-desc" v-model="item.desc" placeholder="ÊèèËø∞...">
                                            </div>
                                        </div>
                                    </template>
                                    <div class="menu-card" style="background:transparent; border:2px dashed var(--border); opacity:0.5; justify-content:center; align-items:center; cursor:pointer;" @click="addItem(gIdx)">
                                        <span style="font-size:24px; color:var(--text-sub)">+</span>
                                    </div>
                                </div>
                            </div>
                        </template>
                        <div style="text-align:right; padding:30px; color:var(--text-sub); font-size:12px;">Powered by AstrBot</div>
                    </div>
                </template>

                <template v-else>
                    <div class="canvas-grid" :style="{ transform: `scale(${zoom})`, transformOrigin: 'top center', '--grid-cols': getDesign().grid_columns }">
                        <div :style="{ textAlign: getDesign().title_align, marginBottom: '40px' }">
                            <input class="editable text-main" v-model="config.title" :style="{ textAlign: getDesign().title_align }">
                            <input class="editable text-sub" v-model="config.subtitle" :style="{ textAlign: getDesign().title_align }" placeholder="ÂâØÊ†áÈ¢ò">
                        </div>

                        <div class="widget-grid" ref="widgetGrid">
                            <div v-for="(group, gIdx) in config.groups" :key="gIdx" 
                                 v-show="group.enabled !== false"
                                 :class="['group-widget', resizing && resizing.idx === gIdx ? 'resizing' : '']"
                                 draggable="true" @dragstart="dragStartGroup(gIdx, $event)" @dragover.prevent @drop="dropOnGroupList(gIdx)"
                                 :style="{ gridColumn: `span ${Math.min(group.span || 2, getDesign().grid_columns)}` }">
                                
                                <div class="resize-handle-drag" @mousedown.stop.prevent="startResize(gIdx, $event)">
                                    <div class="resize-icon"></div>
                                </div>

                                <div class="gw-header">
                                    <div class="gw-deco" :style="{ background: getGroupColor(gIdx) }"></div>
                                    <input class="editable text-group" v-model="group.title" style="font-size:20px;">
                                </div>

                                <div style="display:grid; gap:10px;" :style="{ gridTemplateColumns: `repeat(${group.cols || 1}, 1fr)` }">
                                    <div v-for="(item, iIdx) in group.menus" :key="iIdx" class="menu-pill">
                                        <input class="editable" v-model="item.name" placeholder="ÂäüËÉΩ">
                                        <span style="cursor:pointer; color:var(--text-sub); font-size:12px;" @click="removeItem(gIdx, iIdx)">√ó</span>
                                    </div>
                                    <button class="btn-mini" style="width:100%; border:1px dashed var(--border); padding:8px; background:transparent" @click="addItem(gIdx)">+</button>
                                </div>

                                <div style="margin-top:15px; border-top:1px solid var(--border); padding-top:8px; display:flex; justify-content:space-between; align-items:center;">
                                    <span style="font-size:12px; color:var(--text-sub)">ÂÜÖÈÉ®ÂàóÊï∞: {{group.cols||1}}</span>
                                    <div style="display:flex; gap:2px;">
                                        <button class="btn-mini" @click="group.cols = Math.max(1, (group.cols||1)-1)">-</button>
                                        <button class="btn-mini" @click="group.cols = Math.min(3, (group.cols||1)+1)">+</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </template>
            </div>
        </div>

        <div v-if="showPreview" class="modal-mask" @click.self="showPreview = false">
            <div v-if="previewLoading" style="color:white; font-size:1.2rem;">Ê∏≤Êüì‰∏≠...</div>
            <img v-if="previewUrl && !previewLoading" :src="previewUrl" class="preview-image">
        </div>
    </div>

    <script>
        const { createApp } = Vue
        createApp({
            data() {
                return {
                    config: { title: "AstrBot", subtitle: "", groups: [], design: {} },
                    zoom: 1.0, dragSrc: null, saving: false, toastMsg: "", toastClass: "",
                    showPreview: false, previewLoading: false, previewUrl: null,
                    deleteTargetIdx: -1,
                    resizing: null 
                }
            },
            mounted() { this.loadConfig(); },
            watch: {
                config: {
                    handler(val) {
                        const theme = val.design?.theme || 'dark';
                        document.documentElement.setAttribute('data-theme', theme);
                    }, deep: true
                }
            },
            methods: {
                getDesign() { 
                    if (!this.config.design) this.config.design = {};
                    if (!this.config.design.layout_mode) this.config.design.layout_mode = 'list';
                    if (!this.config.design.layout_columns) this.config.design.layout_columns = 2;
                    if (!this.config.design.grid_columns) this.config.design.grid_columns = 4;
                    if (!this.config.design.theme) this.config.design.theme = 'dark';
                    if (!this.config.design.title_align) this.config.design.title_align = 'center';
                    return this.config.design; 
                },
                getGroupColor(idx) { return `hsl(${(210 + (idx * 137.5)) % 360}, 85%, 60%)`; },
                
                toggleTheme() { 
                    const d = this.getDesign(); d.theme = d.theme === 'light' ? 'dark' : 'light';
                    this.saveConfig(true); 
                },
                switchMode(mode) {
                    this.config.design.layout_mode = mode;
                    this.saveConfig(true); 
                },

                calculateCellWidth() {
                    const containerW = 800 - 60; // 800 - padding(30+30)
                    const cols = this.getDesign().grid_columns;
                    const gapsTotal = (cols - 1) * 20;
                    return (containerW - gapsTotal) / cols;
                },
                startResize(gIdx, e) {
                    const group = this.config.groups[gIdx];
                    this.resizing = {
                        idx: gIdx,
                        startX: e.clientX,
                        startSpan: group.span || 2,
                        cellUnit: this.calculateCellWidth() + 20 
                    };
                },
                handleResizeMove(e) {
                    if (!this.resizing) return;
                    // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÈô§‰ª• zoom Á≥ªÊï∞Ôºå‰øÆÂ§çÁº©ÊîæÂêéÁöÑÊãñÊãΩË∑ùÁ¶ªÂÅèÂ∑Æ
                    const dx = (e.clientX - this.resizing.startX) / this.zoom;
                    const deltaCols = Math.round(dx / this.resizing.cellUnit);
                    let newSpan = this.resizing.startSpan + deltaCols;
                    const maxCols = this.getDesign().grid_columns;
                    if (newSpan < 1) newSpan = 1;
                    if (newSpan > maxCols) newSpan = maxCols;
                    this.config.groups[this.resizing.idx].span = newSpan;
                },
                handleResizeUp() {
                    if (this.resizing) {
                        this.resizing = null;
                        this.saveConfig(true); 
                    }
                },

                async loadConfig() {
                    try {
                        const res = await fetch('/api/config');
                        const data = await res.json();
                        // „ÄêÂÖ≥ÈîÆ‰øÆÂ§ç„ÄëÂº∫Âà∂Ë°•ÂÖ® grid_columns ÈªòËÆ§ÂÄº
                        if (!data.design) data.design = {};
                        if (!data.design.grid_columns) data.design.grid_columns = 3; // ÈªòËÆ§3Âàó
                        
                        if(data.groups) {
                            data.groups.forEach(g => {
                                if(!g.span) g.span = 2;
                                if(!g.cols) g.cols = 1;
                            });
                        }
                        this.config = data;
                    } catch(e) { this.showToast("Âä†ËΩΩÂ§±Ë¥•"); }
                },
                
                async saveConfig(isSilent) {
                    this.saving = true;
                    const silent = isSilent === true;
                    try {
                        await fetch('/api/config', { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(this.config) });
                        if (!silent) this.showToast("‰øùÂ≠òÊàêÂäü ‚úÖ");
                    } catch(e) { 
                        this.showToast("‰øùÂ≠òÂ§±Ë¥• ‚ùå"); 
                    } finally { 
                        this.saving = false; 
                    }
                },
                async fetchBackendPreview() {
                    this.showPreview = true; this.previewLoading = true;
                    try {
                        const res = await fetch('/api/preview', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(this.config) });
                        if (!res.ok) throw new Error();
                        this.previewUrl = URL.createObjectURL(await res.blob());
                    } catch (e) { this.showToast("È¢ÑËßàÂ§±Ë¥•"); this.showPreview = false; } finally { this.previewLoading = false; }
                },
                dragStartGroup(gIdx, e) { 
                    if (this.resizing) { e.preventDefault(); return; }
                    this.dragSrc = { type: 'group', idx: gIdx }; 
                },
                dropOnGroupList(targetGIdx) {
                    if (!this.dragSrc || this.dragSrc.type !== 'group') return;
                    const group = this.config.groups.splice(this.dragSrc.idx, 1)[0];
                    this.config.groups.splice(targetGIdx, 0, group);
                    this.dragSrc = null;
                },
                dragStartItem(gIdx, iIdx, e) { this.dragSrc = { type: 'item', gIdx, iIdx }; },
                dropOnItem(targetGIdx, targetIIdx) {
                    if (!this.dragSrc || this.dragSrc.type !== 'item') return;
                    const item = this.config.groups[this.dragSrc.gIdx].menus.splice(this.dragSrc.iIdx, 1)[0];
                    this.config.groups[targetGIdx].menus.splice(targetIIdx, 0, item);
                    this.dragSrc = null;
                },
                dropOnGroupCanvas(targetGIdx) {
                    if (!this.dragSrc || this.dragSrc.type !== 'item') return;
                    const item = this.config.groups[this.dragSrc.gIdx].menus.splice(this.dragSrc.iIdx, 1)[0];
                    this.config.groups[targetGIdx].menus.push(item);
                    this.dragSrc = null;
                },
                addGroup() { this.config.groups.push({ title: "Êñ∞ÂàÜÁªÑ", enabled: true, align: "left", menus: [], span: 2, cols: 1 }); },
                askDelete(idx) { this.deleteTargetIdx = idx; },
                cancelDelete() { this.deleteTargetIdx = -1; },
                removeGroup(idx) { 
                    this.config.groups.splice(idx, 1); 
                    this.deleteTargetIdx = -1; 
                },
                addItem(gIdx) { this.config.groups[gIdx].menus.push({ name: "ÂäüËÉΩ", desc: "", enabled: true }); },
                removeItem(gIdx, iIdx) { this.config.groups[gIdx].menus.splice(iIdx, 1); },
                resizeGroup(idx, delta) {
                    const g = this.config.groups[idx];
                    let s = (g.span || 2) + delta;
                    if(s < 1) s = 1; if(s > 3) s = 3; 
                    g.span = s;
                },
                showToast(msg) { this.toastMsg = msg; this.toastClass = "show"; setTimeout(() => this.toastClass = "", 2000); }
            }
        }).mount('#app')
    </script>
</body>
</html>
